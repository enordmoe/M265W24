<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.52">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Data Science Project Assignment</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="Project_assignment_w25_files/libs/clipboard/clipboard.min.js"></script>
<script src="Project_assignment_w25_files/libs/quarto-html/quarto.js"></script>
<script src="Project_assignment_w25_files/libs/quarto-html/popper.min.js"></script>
<script src="Project_assignment_w25_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Project_assignment_w25_files/libs/quarto-html/anchor.min.js"></script>
<link href="Project_assignment_w25_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Project_assignment_w25_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Project_assignment_w25_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Project_assignment_w25_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Project_assignment_w25_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
  <li><a href="#key-dates" id="toc-key-dates" class="nav-link active" data-scroll-target="#key-dates">Key Dates</a></li>
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a></li>
  <li><a href="#components-of-the-project" id="toc-components-of-the-project" class="nav-link" data-scroll-target="#components-of-the-project">Components of the Project</a>
  <ul class="collapse">
  <li><a href="#project-proposal-and-progress-report" id="toc-project-proposal-and-progress-report" class="nav-link" data-scroll-target="#project-proposal-and-progress-report">Project proposal and progress report</a></li>
  <li><a href="#report" id="toc-report" class="nav-link" data-scroll-target="#report">Report</a></li>
  <li><a href="#presentation" id="toc-presentation" class="nav-link" data-scroll-target="#presentation">Presentation</a></li>
  <li><a href="#deliverables" id="toc-deliverables" class="nav-link" data-scroll-target="#deliverables">Deliverables</a></li>
  </ul></li>
  <li><a href="#tips" id="toc-tips" class="nav-link" data-scroll-target="#tips">Tips</a></li>
  <li><a href="#grading" id="toc-grading" class="nav-link" data-scroll-target="#grading">Grading</a></li>
  <li><a href="#timeline" id="toc-timeline" class="nav-link" data-scroll-target="#timeline">Timeline</a></li>
  <li><a href="#rubric-for-assessment-of-write-up" id="toc-rubric-for-assessment-of-write-up" class="nav-link" data-scroll-target="#rubric-for-assessment-of-write-up">Rubric for Assessment of Write-up</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Data Science Project Assignment</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="key-dates" class="level1">
<h1>Key Dates</h1>
<ul>
<li><strong>Proposal and Progress Report due Friday, February 28</strong></li>
<li><strong>Report and Presentation due Monday, March 17</strong></li>
</ul>
</section>
<section id="overview" class="level1">
<h1>Overview</h1>
<p>The final project for this class is a collaborative analysis of a dataset of your group’s choosing. You will need to form a group of 2 or 3 to work together on this project. Thank you in advance for taking your involvement in the work of the group seriously and for doing your share.</p>
<p>For the purposes of this project, you will need to find “published” data from online sources along the lines of what we’ve been seeing in the Dataset of the Day presentations. You can choose the data based on your interests or based on work in other courses or research projects. The goal of this project is for you to find a dataset that the entire group can be interested in and to demonstrate proficiency in the <strong>tidyverse</strong> techniques we have learned in this class (and beyond, if you like). <strong>Note</strong>: Do NOT include Base R code in your work. I repeat, do NOT use Base R for this analysis. The coding portion of this assignment is intended to demonstrate your proficiency with readable <strong>tidyverse</strong> code.</p>
</section>
<section id="data" class="level1">
<h1>Data</h1>
<p>In order for you to have the greatest chance of success with this project it is important that you choose a manageable yet challenging dataset. This means that the data should be readily accessible and large enough that you can explore several meaningful questions. Rather than download a single tidy data set for analysis, I expect you will need to tidy and possibly combine multiple data sets, possibly from more than one source. You should try to ensure that the data are sufficiently complex and messy to allow you to demonstrate your proficiency using the topics explored so far and those to come in the weeks ahead (e.g., merging, handling strings, dates, mapping, and writing functions to streamline or simplify code).</p>
<p>Once tidied, your dataset should have at least 200 observations (maybe many more) and between 10 to 20 variables (exceptions can be made but speak with me first to get approval). Your dataset should include categorical variables, discrete numerical variables, and continuous numerical variables. A dataset with only categorical or only numerical variables will severely limit the kinds of analyses you can carry out.</p>
<p>One example of an appropriate dataset would be the Ames property lab data. Such a dataset could be created by merging data from several sources (see Chapter 19 on Joins), e.g, using a home sales site like Zillow.com or Redfin plus information about neighborhood, schools, etc.</p>
<p><strong>All analyses must be done in RStudio.</strong> If you are using a dataset that comes in a format that we haven’t encountered in class (e.g., JSON, XML, etc.), make sure that you are able to load it into RStudio as this can be challenging depending on the source. (I can point you to resources that might be helpful.)</p>
<p><strong>Reusing datasets from class:</strong> Do not reuse datasets used in examples or homework in the class or datasets featured in the text. One partial exception is that you may use the Bureau of Transportation website to create your own flight dataset similar to the data in the <code>nyfcflights13</code> package if you obtain data for a different origin city but you should ensure that your analysis is original. A disadvantage of this would be that such data may not present tidying challenges.</p>
<p><strong>Scraping data</strong> You may scrape data (Chapter 24 Web scraping) from a website only if permission is explicitly given by the website and only to the extent permitted.</p>
</section>
<section id="components-of-the-project" class="level1">
<h1>Components of the Project</h1>
<section id="project-proposal-and-progress-report" class="level2">
<h2 class="anchored" data-anchor-id="project-proposal-and-progress-report">Project proposal and progress report</h2>
<p>Due Friday, February 28, this is a two-page proposal and progress report written using Quarto and describing:</p>
<ul>
<li><p>Your data source(s)</p></li>
<li><p>The variables you plan to use, including variables you plan to generate from your raw data</p></li>
<li><p>Questions you plan to address</p></li>
<li><p>An outline of your final product and a description of data visualizations you expect to make</p></li>
<li><p>A progress report describing what work has been completed and what work remains to be completed</p></li>
<li><p>All materials should be kept in your group’s shared repository on GitHub.</p>
<ul>
<li>Code snippets and documents may be stored in the home folder.<br>
</li>
<li>Data files should be stored in a <code>data</code> folder within your repository.</li>
</ul></li>
</ul>
</section>
<section id="report" class="level2">
<h2 class="anchored" data-anchor-id="report">Report</h2>
<p>After providing the description of your dataset and research question in the introduction use the remainder of your write up to showcase how you have arrived at an answer / answers to your questions of interest using any techniques we have learned in this class (and some beyond, if you’re feeling adventurous). The goal is not to do an exhaustive data analysis, but rather to show that you are proficient at asking meaningful questions and answering them with results of data wrangling and visualization, that you are proficient in using R, and that you are proficient at interpreting and presenting the results. Also pay attention to your presentation. Neatness, coherency, and clarity will count.</p>
<p>Your write up must also include a one to two page conclusion and discussion. This will involve a summary of what you have learned about your research question along with data-based arguments supporting your conclusions. Also critique your own methods and provide suggestions for improving your analysis. Issues pertaining to the reliability and validity of your data, and appropriateness of your procedures should be discussed here. A paragraph on what you would do differently if you were able to start over with the project or what you would do next if you were going to continue work on the project should also be included.</p>
<p>The project is very open ended. You should create some kind of compelling visualization(s) of this data in R. All work should be carried out in RStudio and should rely on the capabilities of the <code>tidyverse</code> packages we learned in class (<code>tidyverse</code>) rather than on brute force base R programming. You do not need to visualize all of the data at once. A few high quality visualizations will receive a much higher grade than a large number of poor quality visualizations.</p>
<p>Before you finalize your write up, make sure your chunks are turned off with <code>echo = FALSE</code>. See more on this in the tips section below.</p>
<p>You can add sections as you see fit to your report. Make sure you have a section called Introduction at the beginning and a section called Conclusion at the end. The rest is up to you!</p>
</section>
<section id="presentation" class="level2">
<h2 class="anchored" data-anchor-id="presentation">Presentation</h2>
<p>Presentations will happen during the scheduled exam time for this course. They should be 15 minutes maximum and each team member should say something substantial.</p>
<p>You can use any software you like for your final presentation, including Quarto to create your slides. There isn’t a specific limit to how many slides you can use, just a time limit (15 minutes total). Each team member should get a chance to speak during the presentation. Your presentation should not just be an account of everything you tried but should describe how you created your data and what you learned supported by a very limited number of useful visuals.</p>
</section>
<section id="deliverables" class="level2">
<h2 class="anchored" data-anchor-id="deliverables">Deliverables</h2>
<p>Your submission on GitHub should include:</p>
<ul>
<li><p>Quarto report file (formatted to clearly present all of your code and results)</p></li>
<li><p>HTML output file</p></li>
<li><p>Dataset(s) (in csv format, in a <code>/data</code> folder)</p></li>
<li><p>Presentation (if using Keynote/PowerPoint/Google Slides, export to PDF and put in your GitHub folder, in a <code>/presentation</code> folder)</p></li>
</ul>
<p>Style and format does count for this assignment, so please take the time to make sure everything looks good and your data and code are properly formatted.</p>
</section>
</section>
<section id="tips" class="level1">
<h1>Tips</h1>
<ul>
<li><p>You will need to figure out how best to work collaboratively on GitHub. Discuss in advance how you intend to work. Pull first and commit and push often. I will do my best to help if (Git) conflicts arise but cannot make any guarantees. By making frequent commits, you reduce the chance of losing valuable work.</p></li>
<li><p>Review the grading guidelines below and ask questions if any of the expectations are unclear.</p></li>
<li><p>Set aside time to work together on Teams or whatever works best for you.</p></li>
<li><p>Code: In your write up your code should be hidden (<code>#| echo: false</code>) so that your document is neat and easy to read. However your document should include all your code such that if I re-knit your Quarto input file (<code>qmd</code>), I should be able to obtain the results you presented. <strong>Exception:</strong> If you want to highlight something specific about a piece of code, you are welcome to show that portion.</p></li>
<li><p>Teamwork: You are to complete the assignment as a team. All team members are expected to contribute equally to the completion of this assignment and group assessments will be given at its completion. Anyone judged to not have sufficiently contributed to the final product will have their grade penalized. While different teams members may have different backgrounds and abilities, it is the responsibility of every team member to understand how all code, visualizations and analysis in your work.</p></li>
</ul>
<p><strong>Team peer evaluation</strong> You will be asked to fill out a peer assessment where you rate the contribution and teamwork of each team member out of 10 points. You will additionally report a contribution percentage for each team member. Filling out the survey is a prerequisite for getting credit on the team member evaluation. If you are suggesting that an individual did less than 20% of the work, please provide some explanation. If any individual gets an average peer score indicating that they did less than 10% of the work, this person will receive half the grade of the rest of the group.</p>
<p>Your project score will be based on the quality of your team’s final product and presentation. A high quality Final Product will show your abilities to collect, organize, tidy, visualize and interpret data. It should show both careful work as well as creativity. Your report and presentation should tell a compelling story with excellent written descriptions and graphics.</p>
<p>Late projects will not be accepted except in extraordinary situations.</p>
</section>
<section id="grading" class="level1">
<h1>Grading</h1>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Total</th>
<th style="text-align: center;">100 pts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Proposal</td>
<td style="text-align: center;">20 pts</td>
</tr>
<tr class="even">
<td>Presentation</td>
<td style="text-align: center;">25 pts</td>
</tr>
<tr class="odd">
<td>Peer presentation evaluation</td>
<td style="text-align: center;">5 pts</td>
</tr>
<tr class="even">
<td>Write up</td>
<td style="text-align: center;">30 pts</td>
</tr>
<tr class="odd">
<td>Team peer evaluation</td>
<td style="text-align: center;">10 pts</td>
</tr>
<tr class="even">
<td>RStudio GitHub folder completeness and organization</td>
<td style="text-align: center;">10 pts</td>
</tr>
</tbody>
</table>
</section>
<section id="timeline" class="level1">
<h1>Timeline</h1>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Stage</th>
<th style="text-align: center;">Date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Proposal and progress report</td>
<td style="text-align: center;">Friday, February 28</td>
</tr>
<tr class="even">
<td>Project work day</td>
<td style="text-align: center;">Friday, March 14</td>
</tr>
<tr class="odd">
<td>Final report and presentation</td>
<td style="text-align: center;">Monday, March 17</td>
</tr>
</tbody>
</table>
</section>
<section id="rubric-for-assessment-of-write-up" class="level1">
<h1>Rubric for Assessment of Write-up</h1>
<ol type="1">
<li><p><strong>Introduction (4 points):</strong></p>
<ul>
<li>Clear articulation of the problem statement and objectives.</li>
<li>Background information provided to contextualize the problem.</li>
<li>Hypotheses or research questions clearly stated.</li>
</ul></li>
<li><p><strong>Data Collection and Preprocessing (7 points):</strong></p>
<ul>
<li>Explanation of data sources and methods of collection/aggregation.</li>
<li>Discussion of data cleaning and preprocessing steps.</li>
<li>Justification for data inclusion/exclusion decisions.</li>
<li>Demonstration of proficiency in data wrangling techniques.</li>
</ul></li>
<li><p><strong>Exploratory Data Analysis and Visualization (9 points):</strong></p>
<ul>
<li>Effective use of data visualization techniques for exploration.</li>
<li>Comprehensive exploration of the dataset through visualization.</li>
<li>Identification and interpretation of key insights from visualizations.</li>
<li>Utilization of visualization to identify data quality issues.</li>
</ul></li>
<li><p><strong>Data Understanding (4 points):</strong></p>
<ul>
<li>Demonstration of understanding of the data structure and characteristics.</li>
<li>Explanation of how the data structure and variable types influenced wrangling decisions.</li>
</ul></li>
<li><p><strong>Discussion (4 points):</strong></p>
<ul>
<li>Synthesis of main findings and reflection on challenges.</li>
<li>Explanation of the role of visualization in understanding the dataset.</li>
<li>Consideration of future steps or improvements.</li>
</ul></li>
<li><p><strong>Presentation and Clarity (2 points):</strong></p>
<ul>
<li>Organization and structure of the report.</li>
<li>Clarity of writing and presentation of findings.</li>
<li>Use of Quarto document format and proper citation.</li>
</ul></li>
</ol>
<p><strong>Total: 30 points</strong></p>
<p>Source: Adapted from <a href="https://datasciencebox.org/">Data Science in a Box</a> Project Assignment</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>